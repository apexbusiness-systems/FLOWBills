name: E2E Smoke Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e-smoke:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run basic smoke tests
        run: |
          echo "üîç Running basic smoke tests..."
          
          # Check build output exists
          if [ -d "dist" ]; then
            echo "‚úÖ Build output exists"
          else
            echo "‚ùå Build output missing"
            exit 1
          fi
          
          # Check critical files exist
          if [ -f "dist/index.html" ]; then
            echo "‚úÖ index.html exists"
          else
            echo "‚ùå index.html missing"
            exit 1
          fi
          
          # Check for JS bundle
          if ls dist/assets/*.js 1> /dev/null 2>&1; then
            echo "‚úÖ JavaScript bundles exist"
          else
            echo "‚ùå JavaScript bundles missing"
            exit 1
          fi
          
          echo "‚úÖ Basic smoke tests passed"

      - name: Check Supabase CLI availability
        id: supabase-check
        continue-on-error: true
        run: |
          if command -v supabase &> /dev/null; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Supabase CLI not available - skipping function tests"
          fi

      - name: Setup Supabase CLI
        if: steps.supabase-check.outputs.available != 'true'
        uses: supabase/setup-cli@v1
        continue-on-error: true
        with:
          version: latest
      
      - name: Start Supabase local
        id: supabase-start
        continue-on-error: true
        run: |
          supabase start 2>&1 || {
            echo "‚ö†Ô∏è Supabase failed to start (expected in GitHub Actions without Docker)"
            echo "started=false" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "started=true" >> $GITHUB_OUTPUT
      
      - name: Create .env.local for functions
        if: steps.supabase-start.outputs.started == 'true'
        run: |
          cat > .env.local <<EOF
          SUPABASE_URL=http://localhost:54321
          SUPABASE_ANON_KEY=$(supabase status | grep "anon key" | awk '{print $NF}')
          SUPABASE_SERVICE_ROLE_KEY=$(supabase status | grep "service_role key" | awk '{print $NF}')
          PEPPOL_WEBHOOK_SECRET=test-secret-12345
          HIL_CONFIDENCE_THRESHOLD=70
          EOF
      
      - name: Start Supabase Functions
        if: steps.supabase-start.outputs.started == 'true'
        run: |
          supabase functions serve --env-file .env.local &
          sleep 10
      
      - name: Smoke Test - Validate BIS3 Invoice
        if: steps.supabase-start.outputs.started == 'true'
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:54321/functions/v1/einvoice_validate \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $(supabase status | grep "anon key" | awk '{print $NF}')" \
            -d @- <<'PAYLOAD'
          {
            "document_id": "TEST-001",
            "xml_content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><Invoice xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2\" xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\" xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"><cbc:ID>INV-001</cbc:ID><cbc:IssueDate>2025-01-01</cbc:IssueDate><cbc:DocumentCurrencyCode>EUR</cbc:DocumentCurrencyCode><cac:AccountingSupplierParty><cac:Party><cbc:EndpointID schemeID=\"0088\">1234567890123</cbc:EndpointID><cac:PartyName><cbc:Name>Test Supplier</cbc:Name></cac:PartyName></cac:Party></cac:AccountingSupplierParty><cac:AccountingCustomerParty><cac:Party><cbc:EndpointID schemeID=\"0088\">0987654321098</cbc:EndpointID><cac:PartyName><cbc:Name>Test Customer</cbc:Name></cac:PartyName></cac:Party></cac:AccountingCustomerParty></Invoice>",
            "format": "bis30",
            "tenant_id": "test-tenant"
          }
          PAYLOAD
          )
          
          echo "Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "\"validation_passed\":true"; then
            echo "‚úÖ Validation passed"
          else
            echo "‚ö†Ô∏è Validation check skipped or failed"
          fi
      
      - name: Smoke Test - Metrics Endpoint
        if: steps.supabase-start.outputs.started == 'true'
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s http://localhost:54321/functions/v1/metrics?format=prometheus)
          
          echo "Metrics Response:"
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | grep -q "einvoice_validated_total"; then
            echo "‚úÖ Metrics endpoint working"
          else
            echo "‚ö†Ô∏è Metrics endpoint check skipped"
          fi
      
      - name: Stop Supabase
        if: always() && steps.supabase-start.outputs.started == 'true'
        run: supabase stop || true
