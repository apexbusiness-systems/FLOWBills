name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'

permissions:
  contents: read
  security-events: write

jobs:
  # Quality Gates
  lint-and-format:
    runs-on: ubuntu-latest
    name: üîç Code Quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:check || npm run lint -- --max-warnings=999
        continue-on-error: false

      - name: Check TypeScript
        run: npm run type-check || npx tsc --noEmit
        continue-on-error: false

      - name: Check formatting
        run: npm run format:check || echo "Format check warnings - non-blocking"
        continue-on-error: true

  # Unit and Integration Tests
  test:
    runs-on: ubuntu-latest
    name: üß™ Tests
    needs: lint-and-format

    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: npm run test:unit

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        run: npm run test:integration

      - name: Upload coverage to Codecov
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Performance Testing
  performance:
    runs-on: ubuntu-latest
    name: ‚ö° Performance
    needs: test
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # Security Scan
  security:
    runs-on: ubuntu-latest
    name: üîí Security
    needs: lint-and-format
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level moderate

  # Build and Deploy
  build-and-deploy:
    runs-on: ubuntu-latest
    name: üöÄ Build & Deploy
    needs: [test, performance, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Run production tests
        run: npm run test:prod

      # - name: Deploy to Lovable
      #   id: deploy
      #   uses: lovable-dev/deploy-action@v1
      #   with:
      #     token: ${{ secrets.LOVABLE_TOKEN }}
      #     project-id: ${{ secrets.LOVABLE_PROJECT_ID }}

  # Database Backup
  backup:
    runs-on: ubuntu-latest
    name: üíæ Database Backup
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create database backup
        run: |
          supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" \
            --file "backup-$(date +%Y%m%d-%H%M%S).sql"

      - name: Upload backup to S3
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Sync backup to S3
        run: |
          aws s3 cp backup-*.sql s3://${{ secrets.BACKUP_BUCKET }}/database/
          
  # Notify on Success/Failure
  notify:
    runs-on: ubuntu-latest
    name: üì¢ Notifications
    needs: [build-and-deploy, backup]
    if: always()

    steps:
      - name: Send Slack notification
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            STATUS_EMOJI="‚úÖ"
            if [ "${{ job.status }}" != "success" ]; then
              STATUS_EMOJI="‚ùå"
            fi
            PAYLOAD=$(cat <<EOF
            {
              "text": "${STATUS_EMOJI} CI/CD Pipeline: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CI/CD Pipeline Status*\nStatus: ${{ job.status }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
            EOF
            )
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
            echo "Slack notification sent"
          else
            echo "SLACK_WEBHOOK_URL not configured - skipping notification"
          fi