# TEMPORARILY DISABLED - Configure SLACK_WEBHOOK_URL to re-enable
# P17 — Daily Report Scheduler (09:00 America/Edmonton)
name: Daily Report

on:
  # DISABLED - schedule:
  #   # Run at 09:00 America/Edmonton (16:00 UTC in winter, 15:00 UTC in summer - DST aware)
  #   - cron: '0 16 * * *'
  workflow_dispatch: # Manual trigger for testing

jobs:
  generate-daily-report:
    name: Generate & Send Daily Report
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Get current date in Edmonton timezone
        id: date
        run: |
          REPORT_DATE=$(TZ=America/Edmonton date +'%Y-%m-%d')
          echo "report_date=$REPORT_DATE" >> $GITHUB_OUTPUT
          echo "Generating report for: $REPORT_DATE"
      
      - name: Invoke daily report function
        id: report
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "::warning::SUPABASE_SERVICE_ROLE_KEY not configured - skipping daily report"
            echo '{"error": "Service role key not configured"}' > report-response.json
            echo "report_json<<EOF" >> $GITHUB_OUTPUT
            echo '{"error": "Service role key not configured"}' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://yvyjzlbosmtesldczhnm.supabase.co/functions/v1/daily-report" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" || echo "CURL_ERROR")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "CURL_ERROR" ]; then
            echo "::warning::Daily report function returned HTTP $HTTP_CODE"
            echo "Response: $BODY"
          fi
          
          echo "report_json<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Parse report metrics
        id: metrics
        run: |
          AVAILABILITY=$(echo '${{ steps.report.outputs.report_json }}' | jq -r '.metrics.availability')
          P95_LATENCY=$(echo '${{ steps.report.outputs.report_json }}' | jq -r '.metrics.p95_latency_ms')
          ERROR_RATIO=$(echo '${{ steps.report.outputs.report_json }}' | jq -r '.metrics.error_ratio')
          STP_RATE=$(echo '${{ steps.report.outputs.report_json }}' | jq -r '.metrics.stp_rate')
          INVOICE_VOLUME=$(echo '${{ steps.report.outputs.report_json }}' | jq -r '.metrics.invoice_volume')
          
          echo "availability=$AVAILABILITY" >> $GITHUB_OUTPUT
          echo "p95_latency=$P95_LATENCY" >> $GITHUB_OUTPUT
          echo "error_ratio=$ERROR_RATIO" >> $GITHUB_OUTPUT
          echo "stp_rate=$STP_RATE" >> $GITHUB_OUTPUT
          echo "invoice_volume=$INVOICE_VOLUME" >> $GITHUB_OUTPUT
      
      - name: Send report to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Extract formatted report from response
          FORMATTED_REPORT=$(echo '${{ steps.report.outputs.report_json }}' | jq -r '.formatted_report')
          
          # Send to Slack (if webhook configured)
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"text\": \"$FORMATTED_REPORT\"}"
            echo "Report sent to Slack"
          else
            echo "Slack webhook not configured - skipping notification"
          fi
      
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ steps.date.outputs.report_date }}
          path: |
            ${{ steps.report.outputs.report_json }}
          retention-days: 90
      
      - name: Check SLO violations
        continue-on-error: true
        run: |
          AVAILABILITY=${{ steps.metrics.outputs.availability }}
          P95_LATENCY=${{ steps.metrics.outputs.p95_latency }}
          ERROR_RATIO=${{ steps.metrics.outputs.error_ratio }}
          
          VIOLATIONS=""
          
          # Use awk for floating point comparison (more reliable than bc)
          if [ -n "$AVAILABILITY" ] && [ -n "$P95_LATENCY" ] && [ -n "$ERROR_RATIO" ]; then
            if awk "BEGIN {exit !($AVAILABILITY < 99.5)}"; then
              VIOLATIONS="$VIOLATIONS\n⚠️ Availability SLO violated: ${AVAILABILITY}% < 99.5%"
            fi
            
            if awk "BEGIN {exit !($P95_LATENCY > 800)}"; then
              VIOLATIONS="$VIOLATIONS\n⚠️ Latency SLO violated: ${P95_LATENCY}ms > 800ms"
            fi
            
            if awk "BEGIN {exit !($ERROR_RATIO > 0.5)}"; then
              VIOLATIONS="$VIOLATIONS\n⚠️ Error ratio SLO violated: ${ERROR_RATIO}% > 0.5%"
            fi
          else
            echo "::warning::Metrics not available for SLO check"
          fi
          
          if [ -n "$VIOLATIONS" ]; then
            echo -e "SLO Violations Detected:$VIOLATIONS"
            echo "::warning::SLO violations detected - see report for details"
          else
            echo "✅ All SLOs met"
          fi
