# Reusable Notifications Workflow - Elite DevOps Protocol
# Fixes: Heredoc syntax errors with literal INNEREOF marker + sed replacement
name: Notifications

on:
  workflow_call:
    inputs:
      status:
        description: 'Status of the triggering workflow (success, failure, cancelled)'
        required: true
        type: string
      title:
        description: 'Notification title'
        required: true
        type: string
      message:
        description: 'Notification message body'
        required: false
        type: string
        default: ''
      environment:
        description: 'Environment name (production, staging, development)'
        required: false
        type: string
        default: 'unknown'
      severity:
        description: 'Severity level (info, warning, error, critical)'
        required: false
        type: string
        default: 'info'
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
      DISCORD_WEBHOOK_URL:
        required: false
      PAGERDUTY_KEY:
        required: false

  workflow_dispatch:
    inputs:
      status:
        description: 'Status'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - failure
          - cancelled
      title:
        description: 'Notification title'
        required: true
        default: 'Test Notification'
      message:
        description: 'Notification message'
        required: false
        default: 'This is a test notification'
      environment:
        description: 'Environment'
        required: false
        default: 'development'
      severity:
        description: 'Severity level'
        required: false
        default: 'info'
        type: choice
        options:
          - info
          - warning
          - error
          - critical

jobs:
  prepare:
    runs-on: ubuntu-latest
    name: Prepare Notification
    outputs:
      emoji: ${{ steps.style.outputs.emoji }}
      color: ${{ steps.style.outputs.color }}
      slack_color: ${{ steps.style.outputs.slack_color }}

    steps:
      - name: Determine Styling
        id: style
        run: |
          STATUS="${{ inputs.status }}"
          SEVERITY="${{ inputs.severity }}"

          case "$STATUS" in
            success)
              EMOJI="white_check_mark"
              COLOR="good"
              SLACK_COLOR="#36a64f"
              ;;
            failure)
              EMOJI="x"
              COLOR="danger"
              SLACK_COLOR="#ff0000"
              ;;
            cancelled)
              EMOJI="stop_sign"
              COLOR="warning"
              SLACK_COLOR="#ffcc00"
              ;;
            *)
              EMOJI="information_source"
              COLOR="default"
              SLACK_COLOR="#808080"
              ;;
          esac

          # Override for critical severity
          if [ "$SEVERITY" = "critical" ]; then
            EMOJI="rotating_light"
            SLACK_COLOR="#ff0000"
          fi

          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "slack_color=$SLACK_COLOR" >> $GITHUB_OUTPUT

  slack:
    runs-on: ubuntu-latest
    name: Slack Notification
    needs: prepare

    steps:
      - name: Send Slack Notification
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured - skipping"
            exit 0
          fi

          # Use literal heredoc to prevent shell interpolation issues
          # This is the critical fix for heredoc syntax errors
          PAYLOAD_TEMPLATE=$(cat <<'INNEREOF'
          {
            "attachments": [
              {
                "color": "__SLACK_COLOR__",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": ":__EMOJI__: __TITLE__",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {"type": "mrkdwn", "text": "*Status:*\n__STATUS__"},
                      {"type": "mrkdwn", "text": "*Environment:*\n__ENVIRONMENT__"},
                      {"type": "mrkdwn", "text": "*Severity:*\n__SEVERITY__"},
                      {"type": "mrkdwn", "text": "*Triggered by:*\n__ACTOR__"}
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Details:*\n__MESSAGE__"
                    }
                  },
                  {
                    "type": "context",
                    "elements": [
                      {"type": "mrkdwn", "text": "<__RUN_URL__|View Workflow> | __TIMESTAMP__"}
                    ]
                  }
                ]
              }
            ]
          }
INNEREOF
          )

          # Use sed for safe variable replacement (avoids shell quoting issues)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          PAYLOAD=$(echo "$PAYLOAD_TEMPLATE" | \
            sed "s|__SLACK_COLOR__|${{ needs.prepare.outputs.slack_color }}|g" | \
            sed "s|__EMOJI__|${{ needs.prepare.outputs.emoji }}|g" | \
            sed "s|__TITLE__|${{ inputs.title }}|g" | \
            sed "s|__STATUS__|${{ inputs.status }}|g" | \
            sed "s|__ENVIRONMENT__|${{ inputs.environment }}|g" | \
            sed "s|__SEVERITY__|${{ inputs.severity }}|g" | \
            sed "s|__ACTOR__|${{ github.actor }}|g" | \
            sed "s|__MESSAGE__|${{ inputs.message }}|g" | \
            sed "s|__RUN_URL__|${RUN_URL}|g" | \
            sed "s|__TIMESTAMP__|${TIMESTAMP}|g")

          # Retry logic (3 attempts with exponential backoff)
          MAX_RETRIES=3
          RETRY_COUNT=0
          RETRY_DELAY=2

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
              -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Slack notification sent successfully"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Attempt $RETRY_COUNT failed (HTTP $HTTP_CODE), retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          echo "::warning::Slack notification failed after $MAX_RETRIES attempts (HTTP $HTTP_CODE)"
          cat /tmp/slack_response.txt 2>/dev/null || true

          # Non-blocking exit to prevent CI failures
          exit 0

  discord:
    runs-on: ubuntu-latest
    name: Discord Fallback
    needs: prepare
    if: inputs.status == 'failure' || inputs.severity == 'critical'

    steps:
      - name: Send Discord Notification
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not configured - skipping"
            exit 0
          fi

          # Determine Discord color (decimal format)
          case "${{ inputs.status }}" in
            success) DISCORD_COLOR=3066993 ;;  # Green
            failure) DISCORD_COLOR=16711680 ;; # Red
            *) DISCORD_COLOR=16776960 ;;       # Yellow
          esac

          # Use literal heredoc for Discord payload
          PAYLOAD_TEMPLATE=$(cat <<'INNEREOF'
          {
            "content": ":__EMOJI__: **__TITLE__**",
            "embeds": [
              {
                "title": "__TITLE__",
                "description": "__MESSAGE__",
                "color": __DISCORD_COLOR__,
                "fields": [
                  {"name": "Status", "value": "__STATUS__", "inline": true},
                  {"name": "Environment", "value": "__ENVIRONMENT__", "inline": true},
                  {"name": "Severity", "value": "__SEVERITY__", "inline": true},
                  {"name": "Repository", "value": "__REPO__", "inline": true},
                  {"name": "Actor", "value": "__ACTOR__", "inline": true}
                ],
                "footer": {"text": "FLOWBills Notifications"},
                "timestamp": "__ISO_TIMESTAMP__"
              }
            ]
          }
INNEREOF
          )

          ISO_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          PAYLOAD=$(echo "$PAYLOAD_TEMPLATE" | \
            sed "s|__EMOJI__|${{ needs.prepare.outputs.emoji }}|g" | \
            sed "s|__TITLE__|${{ inputs.title }}|g" | \
            sed "s|__MESSAGE__|${{ inputs.message }}|g" | \
            sed "s|__DISCORD_COLOR__|${DISCORD_COLOR}|g" | \
            sed "s|__STATUS__|${{ inputs.status }}|g" | \
            sed "s|__ENVIRONMENT__|${{ inputs.environment }}|g" | \
            sed "s|__SEVERITY__|${{ inputs.severity }}|g" | \
            sed "s|__REPO__|${{ github.repository }}|g" | \
            sed "s|__ACTOR__|${{ github.actor }}|g" | \
            sed "s|__ISO_TIMESTAMP__|${ISO_TIMESTAMP}|g")

          # Retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
              -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "Discord notification sent successfully"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $RETRY_COUNT failed (HTTP $HTTP_CODE), retrying..."
            sleep 2
          done

          echo "::warning::Discord notification failed after $MAX_RETRIES attempts"
          # Non-blocking exit
          exit 0

  pagerduty:
    runs-on: ubuntu-latest
    name: PagerDuty Alert
    needs: prepare
    if: inputs.severity == 'critical' || inputs.severity == 'error'

    steps:
      - name: Send PagerDuty Alert
        continue-on-error: true
        env:
          PAGERDUTY_KEY: ${{ secrets.PAGERDUTY_KEY }}
        run: |
          if [ -z "$PAGERDUTY_KEY" ]; then
            echo "PAGERDUTY_KEY not configured - skipping"
            exit 0
          fi

          # Determine event action
          EVENT_ACTION="trigger"
          if [ "${{ inputs.status }}" = "success" ]; then
            EVENT_ACTION="resolve"
          fi

          # Use literal heredoc for PagerDuty payload
          PAYLOAD_TEMPLATE=$(cat <<'INNEREOF'
          {
            "routing_key": "__ROUTING_KEY__",
            "event_action": "__EVENT_ACTION__",
            "dedup_key": "__DEDUP_KEY__",
            "payload": {
              "summary": "__TITLE__",
              "severity": "__SEVERITY__",
              "source": "__REPO__",
              "component": "__WORKFLOW__",
              "group": "__ENVIRONMENT__",
              "class": "github-actions",
              "custom_details": {
                "status": "__STATUS__",
                "actor": "__ACTOR__",
                "message": "__MESSAGE__",
                "run_url": "__RUN_URL__"
              }
            }
          }
INNEREOF
          )

          DEDUP_KEY="${{ github.repository }}-${{ github.workflow }}-${{ github.run_id }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          PAYLOAD=$(echo "$PAYLOAD_TEMPLATE" | \
            sed "s|__ROUTING_KEY__|${{ secrets.PAGERDUTY_KEY }}|g" | \
            sed "s|__EVENT_ACTION__|${EVENT_ACTION}|g" | \
            sed "s|__DEDUP_KEY__|${DEDUP_KEY}|g" | \
            sed "s|__TITLE__|${{ inputs.title }}|g" | \
            sed "s|__SEVERITY__|${{ inputs.severity }}|g" | \
            sed "s|__REPO__|${{ github.repository }}|g" | \
            sed "s|__WORKFLOW__|${{ github.workflow }}|g" | \
            sed "s|__ENVIRONMENT__|${{ inputs.environment }}|g" | \
            sed "s|__STATUS__|${{ inputs.status }}|g" | \
            sed "s|__ACTOR__|${{ github.actor }}|g" | \
            sed "s|__MESSAGE__|${{ inputs.message }}|g" | \
            sed "s|__RUN_URL__|${RUN_URL}|g")

          HTTP_CODE=$(curl -s -o /tmp/pd_response.txt -w "%{http_code}" \
            -X POST "https://events.pagerduty.com/v2/enqueue" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          if [ "$HTTP_CODE" = "202" ]; then
            echo "PagerDuty alert sent successfully"
          else
            echo "::warning::PagerDuty alert failed (HTTP $HTTP_CODE)"
            cat /tmp/pd_response.txt 2>/dev/null || true
          fi

          # Non-blocking exit
          exit 0

  summary:
    runs-on: ubuntu-latest
    name: Summary
    needs: [slack, discord, pagerduty]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Channel | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Slack | ${{ needs.slack.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Discord | ${{ needs.discord.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PagerDuty | ${{ needs.pagerduty.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ inputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ inputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity:** ${{ inputs.severity }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
